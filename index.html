<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sprinkler Runtime Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    color: #222;
    margin: 0;
    padding: 2rem;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  #container {
    max-width: 645px;
    width: 100%;
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    box-sizing: border-box;
  }
  h1 { text-align: center; margin-bottom: 0.2rem; }
  p.description {
    font-size: 0.9rem;
    color: #555;
    margin: 0;
    margin-bottom: 1.5rem;
    line-height: 1.4;
  }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  .or-divider {
    text-align: center;
    margin: 1rem 0;
    font-size: 1rem;
    color: #666;
  }
  input[type="number"], input[type="text"] {
    padding: 0.6rem;
    font-size: 1rem;
    width: 100%;
    margin-top: 0.3rem;
    border: 1px solid #bbb;
    border-radius: 6px;
    box-sizing: border-box;
  }
  #suggestions {
    border: 1px solid #ccc;
    border-top: none;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background: white;
    z-index: 10;
    width: calc(100% - 2px);
    display: none;
  }
  #suggestions div {
    padding: 0.5rem;
    cursor: pointer;
  }
  #suggestions div:hover {
    background: #f0f0f0;
  }
  #sprinklerZones {
    margin-top: 1rem;
    background: #f9fafb;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 8px;
  }
  .zone-row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
  .zone-row input {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .zone-row input.zone-name { flex: 2; }
  .zone-row input.zone-rate { flex: 1; }
  .zone-row button {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    width: 41px;
    font-size: 1.3rem;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
  }
  .zone-row button:hover { background: #b02a37; }
  button {
    margin-top: 1rem;
    padding: 0.75rem;
    font-size: 1.1rem;
    width: 100%;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.25s ease;
  }
  #addZoneBtn { background-color: #28a745; color: white; }
  #addZoneBtn:hover { background-color: #1e7e34; }
  #locationBtn { background-color: #007bff; color: white; }
  #locationBtn:hover { background-color: #0056b3; }
  #calculateBtn { background-color: #17a2b8; color: white; }
  #calculateBtn:hover { background-color: #117a8b; }
  #results {
    margin-top: 2rem;
    background: #e9f7fa;
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-line;
    box-shadow: inset 0 0 10px rgb(0 123 255 / 0.2);
    font-size: 1rem;
    line-height: 1.4;
  }
  .labels-row { display: flex; gap: 0.75rem; margin: 0.25rem 0 0.75rem; font-weight: bold; font-size: 0.95rem; color: #555; }
  .labels-row > div.zone-name { flex: 2; }
  .labels-row > div.zone-rate { flex: 1; }
  @media (max-width: 480px) {
    .zone-row, .labels-row { flex-direction: column; }
    .zone-row input, .labels-row > div { width: 100%; flex: none; }
    .zone-row button { width: 100%; font-size: 1.5rem; margin-top: 0.25rem; }
  }
</style>
</head>
<body>
<div id="container">
  <h1>Sprinkler Runtime Calculator</h1>
  <br>
  <p class="description">
    Calculate the runtime for your sprinkler zones based on NOAA GFS weather forecast data.<br><br>
    The runtime formula uses variables:<br><br>
    <code>W</code> = watering frequency in days<br>
    <code>ET</code> = weekly evapotranspiration in inches for your location<br>
    <code>R</code> = weekly total rainfall in inches for your location<br>
    <code>Rate</code> = minutes to irrigate 1" water for your sprinklers<br><br>
    Optional: Enter your own variable values and/or runtime formula using <code>W</code>, <code>ET</code>, <code>R</code>, and <code>Rate</code>.
  </p>

  <button id="locationBtn" type="button">Use My Current Location</button>

  <label>
    Location (City, ZIP, or Address):
    <input type="text" id="locationInput" placeholder="Enter city, ZIP code, or address" autocomplete="off" />
    <div id="suggestions"></div>
  </label>

  <div class="or-divider">— OR —</div>

  <label>
    Latitude:
    <input type="number" id="latitude" placeholder="Enter latitude" step="0.0001" />
  </label>

  <label>
    Longitude:
    <input type="number" id="longitude" placeholder="Enter longitude" step="0.0001" />
  </label>

  <label>
    (Optional) Watering Frequency (days):
    <input type="number" id="wateringFrequency" placeholder="Default: 2" min="1" />
  </label>

  <label>
    (Optional) ET Replacement (%):
    <input type="number" id="etReplacement" placeholder="Default: 75" min="0" max="100" />
  </label>

  <label>
    (Optional) Formula Override:
    <input type="text" id="formulaInput" placeholder="Default: (W / 7) * (ET * 0.75 - R) * Rate" />
  </label>

  <div id="sprinklerZones">
    <div class="labels-row">
      <div class="zone-name">Sprinkler Zone Name</div>
      <div class="zone-rate">Minutes per 1"</div>
      <div style="width: 32px;"></div>
    </div>
  </div>

  <button id="addZoneBtn" type="button">+ Add Sprinkler Zone</button>
  <button id="calculateBtn" type="button">Calculate Runtime</button>

  <div id="results" style="display:none;"></div>
</div>

<script>
  const zonesContainer = document.getElementById("sprinklerZones");
  const resultsDiv = document.getElementById("results");
  const suggestionsDiv = document.getElementById("suggestions");
  let selectedCoords = null;

  function addZone(name = "", rate = "") {
    const div = document.createElement("div");
    div.classList.add("zone-row");
    div.innerHTML = `
      <input type="text" class="zone-name" placeholder="Zone name" value="${name}" />
      <input type="number" class="zone-rate" min="0" placeholder="Minutes per 1 inch" value="${rate}" />
      <button type="button">×</button>
    `;
    div.querySelector("button").onclick = () => div.remove();
    zonesContainer.appendChild(div);
  }
  addZone();
  document.getElementById("addZoneBtn").onclick = () => addZone();

  function looksLikeAddress(q) {
    return /^\d/.test(q.trim()) || /\b(st|street|rd|road|ave|avenue|blvd|drive|dr|lane|ln)\b/i.test(q);
  }

  function formatSuggestion(item, isAddress) {
    const addr = item.address || {};
    if (isAddress) return item.display_name;
    const city = addr.city || addr.town || addr.village || "";
    const state = addr.state || "";
    const postcode = addr.postcode || "";
    return [city, state, postcode].filter(s => s).join(", ");
  }

  async function searchLocation(query) {
    if (query.length < 2) {
      suggestionsDiv.style.display = "none";
      return;
    }
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=us&q=${encodeURIComponent(query)}`;
      const resp = await fetch(url);
      const data = resp.ok ? await resp.json() : [];
      suggestionsDiv.innerHTML = "";
      const isAddr = looksLikeAddress(query);
      data.forEach(item => {
        const div = document.createElement("div");
        div.textContent = formatSuggestion(item, isAddr);
        div.onclick = () => {
          document.getElementById("locationInput").value = formatSuggestion(item, isAddr);
          selectedCoords = { lat: parseFloat(item.lat), lon: parseFloat(item.lon) };
          suggestionsDiv.style.display = "none";
        };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.style.display = data.length ? "block" : "none";
    } catch {
      suggestionsDiv.style.display = "none";
    }
  }

  document.getElementById("locationInput").addEventListener("input", e => {
    selectedCoords = null;
    searchLocation(e.target.value);
  });
  document.addEventListener("click", e => {
    if (!document.getElementById("locationInput").contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = "none";
    }
  });

  document.getElementById("locationBtn").onclick = () => {
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude.toFixed(4);
      const lon = pos.coords.longitude.toFixed(4);
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lon;
      selectedCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=${lat}&lon=${lon}&countrycodes=us`);
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        const isAddr = looksLikeAddress(data.display_name || "");
        document.getElementById("locationInput").value = formatSuggestion(data, isAddr);
      } catch {
        // No fallback changes needed
      }
    }, err => alert("Location error: " + err.message));
  };

  function sumArray(arr) { return arr.reduce((a, b) => a + b, 0); }
  function formatMinutes(mins) {
    if (mins <= 0) return "0 min";
    const hrs = Math.floor(mins / 60), minsOnly = Math.round(mins % 60);
    return hrs > 0 ? `${hrs} hr ${minsOnly} min` : `${minsOnly} min`;
  }
  async function fetchWeatherData(lat, lon) {
    const endpoint = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=precipitation_sum,et0_fao_evapotranspiration&forecast_days=7&precipitation_unit=inch&timezone=auto&models=gfs_seamless`;
    const resp = await fetch(endpoint);
    if (!resp.ok) throw new Error("Weather fetch failed");
    return await resp.json();
  }

  function evaluateFormula(formula, vars) {
    try {
      let exp = formula;
      for (const [k, v] of Object.entries(vars)) {
        exp = exp.replace(new RegExp(`\\b${k}\\b`, "g"), v);
      }
      if (!/^[0-9+\-*/().\s]+$/.test(exp)) throw new Error("Invalid characters");
      return Function(`"use strict"; return (${exp})`)();
    } catch {
      throw new Error("Formula evaluation failed.");
    }
  }

  document.getElementById("calculateBtn").onclick = async () => {
    resultsDiv.style.display = "block";
    resultsDiv.textContent = "Fetching weather data...";
    let lat = parseFloat(document.getElementById("latitude").value);
    let lon = parseFloat(document.getElementById("longitude").value);
    if (!selectedCoords && (isNaN(lat) || isNaN(lon))) {
      return resultsDiv.textContent = "Please enter a location or latitude/longitude.";
    }
    if (selectedCoords) {
      lat = selectedCoords.lat;
      lon = selectedCoords.lon;
    }
    let W = parseFloat(document.getElementById("wateringFrequency").value);
    if (isNaN(W) || W <= 0) W = 2;
    let ETrepl = parseFloat(document.getElementById("etReplacement").value);
    if (isNaN(ETrepl) || ETrepl < 0 || ETrepl > 100) ETrepl = 75;
    ETrepl = ETrepl / 100;
    const formulaRaw = document.getElementById("formulaInput").value.trim();
    const formula = formulaRaw || "(W / 7) * (ET * ETrepl - R) * Rate";
    const zones = [];
    for (const row of zonesContainer.querySelectorAll(".zone-row")) {
      const name = row.querySelector(".zone-name").value.trim();
      const rate = parseFloat(row.querySelector(".zone-rate").value);
      if (!name || isNaN(rate) || rate < 0) {
        return resultsDiv.textContent = "Please enter valid zone names and runtimes.";
      }
      zones.push({ name, rate });
    }

    try {
      const data = await fetchWeatherData(lat, lon);
      const weeklyRainfall = sumArray(data.daily.precipitation_sum);
      const weeklyET = sumArray(data.daily.et0_fao_evapotranspiration);
      const lines = zones.map(({ name, rate }) => {
        let runtime = evaluateFormula(formula, { W, ET: weeklyET, R: weeklyRainfall, Rate: rate, ETrepl });
        if (runtime < 0) runtime = 0;
        return `${name}: ${formatMinutes(runtime)}`;
      });
      resultsDiv.innerHTML = `
        <strong>Results:</strong><br><br>
        <strong>Weekly ET:</strong> ${weeklyET.toFixed(3)} in<br>
        <strong>7-Day Total Rainfall:</strong> ${weeklyRainfall.toFixed(3)} in<br><br>
        <strong>Sprinkler Runtime (every ${W} days, ${Math.round(ETrepl * 100)}% weekly ET replacement):</strong><br>
        ${lines.join("<br>")}
      `;
    } catch (err) {
      resultsDiv.textContent = `Error: ${err.message}`;
    }
  };
</script>
</body>
</html>