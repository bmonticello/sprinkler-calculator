<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="deepskyblue" d="M16 2C10 13 4 18 4 22a12 12 0 0024 0c0-4-6-9-12-20z"/><ellipse cx="16" cy="22" rx="7" ry="7" fill="white" fill-opacity="0.5"/></svg>'>
<title>Sprinkler Runtime Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    color: #222;
    margin: 0;
    padding: 2rem;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  #container {
    max-width: 645px;
    width: 100%;
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    box-sizing: border-box;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.2rem;
  }
  p.description {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0;
    margin-bottom: 1.5rem;
    line-height: 1.4;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  input[type="number"], input[type="text"] {
    padding: 0.6rem;
    font-size: 1rem;
    width: 100%;
    margin-top: 0.3rem;
    border: 1px solid #bbb;
    border-radius: 6px;
    box-sizing: border-box;
  }
  #sprinklerZones {
    margin-top: 1rem;
    background: #f9fafb;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 8px;
  }
  .zone-row {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .zone-row input {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .zone-row input.zone-name {
    flex: 2;
  }
  .zone-row input.zone-rate {
    flex: 1;
  }
  .zone-row button {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    width: 41px;
    font-size: 1.3rem;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
  }
  .zone-row button:hover {
    background: #b02a37;
  }
  button {
    margin-top: 1rem;
    padding: 0.75rem;
    font-size: 1.1rem;
    width: 100%;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.25s ease;
  }
  #addZoneBtn {
    background-color: #28a745;
    color: white;
  }
  #addZoneBtn:hover {
    background-color: #1e7e34;
  }
  #locationBtn {
    background-color: #007bff;
    color: white;
  }
  #locationBtn:hover {
    background-color: #0056b3;
  }
  #calculateBtn {
    background-color: #17a2b8;
    color: white;
  }
  #calculateBtn:hover {
    background-color: #117a8b;
  }
  #resetBtn {
    background-color: #dc3545;
    color: white;
    margin-top: 0.5rem;
  }
  #resetBtn:hover {
    background-color: #b02a37;
  }
  #results {
    margin-top: 2rem;
    background: #e9f7fa;
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-line;
    box-shadow: inset 0 0 10px rgb(0 123 255 / 0.2);
    font-size: 1rem;
    line-height: 1.4;
  }
  .labels-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.25rem;
    margin-bottom: 0.75rem;
    font-weight: bold;
    font-size: 0.95rem;
    color: #555;
  }
  .labels-row > div {
    flex-shrink: 0;
  }
  .labels-row > div.zone-name {
    flex: 2;
  }
  .labels-row > div.zone-rate {
    flex: 1;
  }
  @media (max-width: 480px) {
    .zone-row, .labels-row {
      flex-direction: column;
    }
    .zone-row input, .labels-row > div {
      width: 100%;
      flex: none;
    }
    .zone-row button {
      width: 100%;
      font-size: 1.5rem;
      margin-top: 0.25rem;
    }
  }
  .required {
    color: #c00;
    font-weight: normal;
    font-size: 0.95em;
    margin-left: 0.2em;
  }
  .location-note {
    font-size: 0.95em;
    color: #555;
    margin: 0.25em 0 1em 0;
  }
</style>
</head>
<body>
<div id="container">
  <h1 id="pageTop">Sprinkler Runtime Calculator</h1>
  <br/>
  <p class="description">
    Calculate the runtime for your sprinkler zones based on NOAA GFS weather forecast data.<br/>
    <br/>
    The runtime formula uses variables:
    <br/><br/>
    <code>W</code> = watering frequency in days
    <br/>
    <code>ET</code> = weekly evapotranspiration in inches for your location
    <br/>
    <code>R</code> = weekly total rainfall in inches for your location
    <br/>
    <code>Rate</code> = minutes to irrigate 1" water for your sprinklers
    <br/><br/>
    Optional: Enter your own variable values and/or runtime formula below using variables <code>W</code>, <code>ET</code>, <code>R</code>, and <code>Rate</code> (the default values and formula calcula[...]
    <br/><br/>
    <code> (W / 7) * (ET * 0.75 - R) * Rate</code>).
  </p>

  <div>
    <label>
      Location<span class="required">*</span>:
    </label>
    <span class="location-note">Enter either a U.S. ZIP code <strong>or</strong> latitude/longitude.</span>
    <label>
      ZIP Code:
      <input type="text" id="zipcode" placeholder="e.g., 98052" pattern="[0-9]{5}" maxlength="5" inputmode="numeric" autocomplete="postal-code"/>
    </label>
    <span style="display:block; margin: 0.5em 0; text-align: center; color: #888;">— or —</span>
    <label>
      Latitude:
      <input type="number" id="latitude" placeholder="Enter latitude (e.g., 47.94)" step="0.0001" />
    </label>
    <label>
      Longitude:
      <input type="number" id="longitude" placeholder="Enter longitude (e.g., -122.21)" step="0.0001" />
    </label>
    <button id="locationBtn" type="button">Use My Current Location</button>
  </div>
  <br/>
  <label>
    Enter Your Sprinkler Zones<span class="required">*</span>:
  </label>
  <br/>
  <div id="sprinklerZones">   
    <div class="labels-row">
      <div class="zone-name">Sprinkler Zone Name</div>
      <div class="zone-rate">Runtime per 1" (minutes)</div>
      <div style="width: 32px;"></div>
    </div>
    <!-- Zone rows go here -->
  </div>

  <button id="addZoneBtn" type="button">+ Add Sprinkler Zone</button>
  <br/><br/>
  <label>
    Optional:
  </label>
  <br/>
  <label>
    Watering Frequency (every X days):
    <input type="number" id="wateringFrequency" placeholder="Default: 2 (water every 2 days)" min="1" />
  </label>

  <label>
    ET Replacement Percentage (%):
    <input type="number" id="etReplacement" placeholder="Default: 75 for 75%" min="0" max="100" />
  </label>

  <label>
    Runtime Formula Override:
    <input type="text" id="formulaInput" placeholder="Default: (W / 7) * (ET * 0.75 - R) * Rate" />
  </label>
  <br/>
  <button id="calculateBtn" type="button">Calculate Runtime</button>
  <button id="resetBtn" type="button">Reset All</button>

  <div id="results" style="display:none;"></div>
</div>

<script>
  const zonesContainer = document.getElementById("sprinklerZones");
  const resultsDiv = document.getElementById("results");
  const zipcodeInput = document.getElementById("zipcode");
  const latInput = document.getElementById("latitude");
  const lonInput = document.getElementById("longitude");
  const wateringFrequencyInput = document.getElementById("wateringFrequency");
  const etReplacementInput = document.getElementById("etReplacement");
  const formulaInput = document.getElementById("formulaInput");
  const addZoneBtn = document.getElementById("addZoneBtn");

  // Add a sprinkler zone input row
  function addZone(name = "", rate = "") {
    const div = document.createElement("div");
    div.classList.add("zone-row");
    div.innerHTML = `
      <input type="text" class="zone-name" placeholder="Zone name" value="${name}" />
      <input type="number" class="zone-rate" min="0" placeholder="Minutes per 1 inch" value="${rate}" />
      <button type="button" title="Remove zone" aria-label="Remove zone">×</button>
    `;
    const btn = div.querySelector("button");
    btn.onclick = () => div.remove();
    zonesContainer.appendChild(div);
  }

  // Start with one empty zone on page load
  addZone();

  // Location button - get user's current location, then reverse geocode to ZIP
  document.getElementById("locationBtn").addEventListener("click", async () => {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude.toFixed(4);
        const lon = pos.coords.longitude.toFixed(4);
        latInput.value = lat;
        lonInput.value = lon;

        // Try to reverse geocode to ZIP code using Nominatim
        let zip = "";
        try {
          const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`);
          if (resp.ok) {
            const data = await resp.json();
            if (data && data.address && data.address.postcode) {
              zip = data.address.postcode.match(/^\d{5}/) ? data.address.postcode.substring(0, 5) : "";
              zipcodeInput.value = zip;
            }
          }
        } catch (e) {
          // If reverse geocode fails, leave ZIP blank
        }
      },
      (err) => alert("Could not get location: " + err.message)
    );
  });

  // Add zone button
  addZoneBtn.addEventListener("click", () => addZone());

  // Helper functions
  function sumArray(arr) {
    return arr.reduce((a, b) => a + b, 0);
  }

  function formatMinutes(mins) {
    if (mins <= 0) return "0 min";
    let hrs = Math.floor(mins / 60);
    let minutes = Math.round(mins % 60);
    return hrs > 0 ? `${hrs} hr ${minutes} min` : `${minutes} min`;
  }

  async function fetchWeatherData(lat, lon) {
    const today = new Date();
    const startDate = today.toISOString().slice(0, 10);
    const endDateObj = new Date();
    endDateObj.setDate(today.getDate() + 6);
    const endDate = endDateObj.toISOString().slice(0, 10);

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&daily=precipitation_sum,et0_fao_evapotranspiration&forecast_days=7&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto&models=gfs_seamless`;

    const resp = await fetch(url);
    if (!resp.ok) throw new Error("Failed to fetch weather data");
    return resp.json();
  }

  // Get lat/lon for a zipcode using Nominatim
  async function getLatLonFromZip(zip) {
    // Nominatim limits: 1 request/sec for fair use
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=us&format=jsonv2&limit=1`);
    if (!resp.ok) throw new Error("Failed to look up ZIP code location");
    const data = await resp.json();
    if (!data || !data.length) throw new Error("Could not find location for ZIP code");
    return {
      lat: parseFloat(data[0].lat),
      lon: parseFloat(data[0].lon)
    };
  }

  // Evaluate formula safely with user input
  function evaluateFormula(formula, vars) {
    try {
      let exp = formula;
      for (const [key, val] of Object.entries(vars)) {
        const regex = new RegExp(`\\b${key}\\b`, "g");
        exp = exp.replace(regex, val);
      }
      if (!/^[0-9+\-*/().\s]+$/.test(exp)) {
        throw new Error("Invalid characters in formula.");
      }
      // eslint-disable-next-line no-new-func
      return Function(`"use strict";return (${exp})`)();
    } catch {
      throw new Error("Formula evaluation failed. Please check your formula syntax.");
    }
  }

  // Validate that either ZIP or both lat/lon are entered
  function getUserLocationInput() {
    const zip = zipcodeInput.value.trim();
    const latVal = latInput.value.trim();
    const lonVal = lonInput.value.trim();

    if (zip && zip.match(/^\d{5}$/)) {
      // Prefer ZIP, ignore lat/lon unless user enters both and not zip
      return { mode: "zip", zip };
    }
    if (latVal && lonVal && !zip) {
      const lat = parseFloat(latVal);
      const lon = parseFloat(lonVal);
      if (!isNaN(lat) && !isNaN(lon)) {
        return { mode: "latlon", lat, lon };
      }
    }
    // If neither, error
    return null;
  }

  document.getElementById("calculateBtn").addEventListener("click", async () => {
    resultsDiv.style.display = "block";
    resultsDiv.textContent = "Validating location input...";

    // Location logic
    const loc = getUserLocationInput();
    let lat, lon;
    if (!loc) {
      resultsDiv.textContent = "Please enter a valid ZIP code (5 digits) or both latitude and longitude.";
      // Scroll to results for error message
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
      return;
    }
    if (loc.mode === "zip") {
      try {
        resultsDiv.textContent = "Looking up ZIP code location...";
        const res = await getLatLonFromZip(loc.zip);
        lat = res.lat;
        lon = res.lon;
        // Also fill lat/lon fields for clarity
        latInput.value = lat.toFixed(4);
        lonInput.value = lon.toFixed(4);
      } catch (e) {
        resultsDiv.textContent = "Could not find latitude/longitude for ZIP code: " + e.message;
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        return;
      }
    } else if (loc.mode === "latlon") {
      lat = loc.lat;
      lon = loc.lon;
    }

    let W = parseFloat(wateringFrequencyInput.value);
    if (isNaN(W) || W <= 0) W = 2;

    let ETrepl = parseFloat(etReplacementInput.value);
    if (isNaN(ETrepl) || ETrepl < 0 || ETrepl > 100) ETrepl = 75;
    ETrepl = ETrepl / 100;

    const formulaRaw = formulaInput.value.trim();
    const formula = formulaRaw || "(W / 7) * (ET * ETrepl - R) * Rate";

    // Read sprinkler zones
    const zones = [];
    const rows = zonesContainer.querySelectorAll(".zone-row");
    for (const row of rows) {
      const name = row.querySelector(".zone-name").value.trim();
      const rateStr = row.querySelector(".zone-rate").value;
      const rate = parseFloat(rateStr);
      if (!name || isNaN(rate) || rate < 0) {
        resultsDiv.textContent = "Please enter valid zone names and runtimes.";
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        return;
      }
      zones.push({ name, rate });
    }

    try {
      resultsDiv.textContent = "Fetching weather data...";
      const data = await fetchWeatherData(lat, lon);

      if (!data.daily || !data.daily.precipitation_sum || !data.daily.et0_fao_evapotranspiration) {
        resultsDiv.textContent = "Incomplete weather data received.";
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        return;
      }

      const weeklyRainfall = sumArray(data.daily.precipitation_sum);
      const weeklyET = sumArray(data.daily.et0_fao_evapotranspiration);

      // Calculate runtimes
      const resultLines = zones.map(({ name, rate }) => {
        const vars = {
          W,
          ET: weeklyET,
          R: weeklyRainfall,
          Rate: rate,
          ETrepl,
        };
        let runtime;
        try {
          runtime = evaluateFormula(formula, vars);
        } catch (err) {
          resultsDiv.textContent = err.message;
          resultsDiv.scrollIntoView({ behavior: 'smooth' });
          throw err;
        }
        if (runtime < 0) runtime = 0;
        return `${name}: ${formatMinutes(runtime)}`;
      });

      resultsDiv.innerHTML =
        `<strong>Weekly ET (evapotranspiration):</strong> ${weeklyET.toFixed(3)} inches<br>` +
        `<strong>Predicted 7-Day Rainfall:</strong> ${weeklyRainfall.toFixed(3)} inches<br><br>` +
        `<strong>Sprinkler Runtime (every ${W} days, ${Math.round(ETrepl * 100)}% weekly ET replacement):</strong><br>` +
        resultLines.join("<br>");
      // Scroll to the results (even on success)
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      if (!resultsDiv.textContent.includes("Formula evaluation failed")) {
        resultsDiv.textContent = `Error fetching weather data: ${error.message}`;
      }
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }
  });

  // If user enters ZIP, clear lat/lon; if user enters lat/lon, clear ZIP (for clarity)
  zipcodeInput.addEventListener("input", function() {
    if (zipcodeInput.value.trim().length === 5) {
      latInput.value = "";
      lonInput.value = "";
    }
  });
  function clearZipIfLatLon() {
    if (latInput.value.trim() && lonInput.value.trim()) {
      zipcodeInput.value = "";
    }
  }
  latInput.addEventListener("input", clearZipIfLatLon);
  lonInput.addEventListener("input", clearZipIfLatLon);

  // RESET BUTTON FUNCTIONALITY
  document.getElementById("resetBtn").addEventListener("click", function() {
    // Clear all inputs
    zipcodeInput.value = "";
    latInput.value = "";
    lonInput.value = "";
    wateringFrequencyInput.value = "";
    etReplacementInput.value = "";
    formulaInput.value = "";

    // Remove all zone rows
    const zoneRows = zonesContainer.querySelectorAll(".zone-row");
    zoneRows.forEach(row => row.remove());

    // Add back one empty zone
    addZone();

    // Hide results
    resultsDiv.style.display = "none";
    resultsDiv.textContent = "";

    // Scroll to top of page smoothly
    // Prefer scrolling to the main container's top (or the heading)
    const pageTop = document.getElementById("pageTop");
    if (pageTop && typeof pageTop.scrollIntoView === "function") {
      pageTop.scrollIntoView({ behavior: 'smooth' });
    } else {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

</script>
</body>
</html>
