<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sprinkler Runtime Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem auto;
    max-width: 600px;
    background: #f9f9f9;
    color: #222;
  }
  h1 {
    text-align: center;
  }
  #description {
    margin-bottom: 1rem;
    font-size: 1rem;
    color: #444;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  input, button {
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    margin-top: 0.2rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  input:focus {
    border-color: #007bff;
    outline: none;
  }
  #zones-container {
    margin-top: 1rem;
  }
  .zone-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    align-items: center;
  }
  /* Zone name input - same width */
  .zone-name {
    flex: 2;
  }
  /* Make runtime input wider: was flex: 1 before, now flex: 1.5 and min-width */
  .zone-rate {
    flex: 1.5;
    min-width: 80px;
  }
  /* Make remove button bigger and easier to tap */
  .zone-row button {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    width: 36px;
    height: 36px;
    font-size: 1.4rem;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
    padding: 0;
    transition: background-color 0.3s ease;
  }
  .zone-row button:hover {
    background-color: #b02a37;
  }
  .input-labels {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    font-weight: bold;
    color: #555;
  }
  .input-labels > div {
    flex: 1;
  }
  .input-labels > div.zone-name-label {
    flex: 2;
  }
  button#addZoneBtn, button#calculateBtn, button#resetBtn {
    margin-top: 1rem;
    padding: 0.5rem 1.25rem;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button#addZoneBtn {
    background-color: #007bff;
    color: white;
  }
  button#addZoneBtn:hover {
    background-color: #0056b3;
  }
  button#calculateBtn {
    background-color: #28a745;
    color: white;
    display: block;
    width: 100%;
    max-width: 300px;
    margin: 1.5rem auto 0 auto;
  }
  button#calculateBtn:hover {
    background-color: #1e7e34;
  }
  button#resetBtn {
    background-color: #ffc107;
    color: #333;
    margin-left: 1rem;
  }
  button#resetBtn:hover {
    background-color: #d39e00;
  }
  #results {
    margin-top: 2rem;
    white-space: pre-line;
    background: white;
    padding: 1rem 1.25rem;
    border-radius: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  @media (max-width: 480px) {
    .zone-row {
      flex-direction: column;
      align-items: stretch;
    }
    .zone-name, .zone-rate, .zone-row button {
      flex: none !important;
      width: 100%;
      min-width: auto;
    }
    .input-labels {
      flex-direction: column;
    }
    .input-labels > div {
      width: 100%;
      flex: none;
      margin-top: 0.3rem;
    }
    button#calculateBtn {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<h1>Sprinkler Runtime Calculator</h1>
<div id="description">
  <p>This calculator estimates sprinkler runtimes based on your local weekly evapotranspiration (ET) and rainfall forecast.</p>
  <p>Formula used for each zone runtime:<br>
     <em>Runtime = Watering Frequency (days/7) × (ET Replacement % × Weekly ET - Weekly Rainfall) × Minutes per inch rate</em></p>
  <p>Adjust your zones, watering frequency, and ET replacement % below.</p>
</div>

<label for="latitude">Latitude:</label>
<input type="number" id="latitude" placeholder="Enter latitude (e.g. 47.94)" step="0.0001" />

<label for="longitude">Longitude:</label>
<input type="number" id="longitude" placeholder="Enter longitude (e.g. -122.21)" step="0.0001" />

<label for="wateringFrequency">Watering Frequency (every x days):</label>
<input type="number" id="wateringFrequency" placeholder="Enter watering frequency, e.g. 2 (default)" min="1" />

<label for="etReplacement">ET Replacement Percentage (0-100%):</label>
<input type="number" id="etReplacement" placeholder="Enter ET replacement %, e.g. 75" min="0" max="100" />

<div class="input-labels">
  <div class="zone-name-label">Sprinkler Zone Name</div>
  <div>Minutes per 1" Water</div>
  <div style="width: 36px;"></div>
</div>
<div id="zones-container"></div>

<button id="addZoneBtn">Add Sprinkler Zone</button>

<button id="calculateBtn">Calculate Runtime</button>

<button id="resetBtn">Reset to Defaults</button>

<div id="results"></div>

<script>
  function createZoneRow(name = "", rate = "") {
    const div = document.createElement("div");
    div.className = "zone-row";

    const inputName = document.createElement("input");
    inputName.type = "text";
    inputName.className = "zone-name";
    inputName.placeholder = "Zone name (e.g. Front Yard)";
    inputName.value = name;

    const inputRate = document.createElement("input");
    inputRate.type = "number";
    inputRate.className = "zone-rate";
    inputRate.placeholder = "Minutes per inch (e.g. 240)";
    inputRate.min = 0;
    inputRate.value = rate;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "×";
    removeBtn.title = "Remove zone";
    removeBtn.addEventListener("click", () => {
      div.remove();
      saveSettings();
    });

    div.appendChild(inputName);
    div.appendChild(inputRate);
    div.appendChild(removeBtn);
    return div;
  }

  function saveSettings() {
    const latitude = document.getElementById("latitude").value;
    const longitude = document.getElementById("longitude").value;
    const wateringFrequency = document.getElementById("wateringFrequency").value;
    const etReplacement = document.getElementById("etReplacement").value;

    const zones = [];
    document.querySelectorAll(".zone-row").forEach(row => {
      const name = row.querySelector(".zone-name").value.trim();
      const rate = row.querySelector(".zone-rate").value.trim();
      if(name && rate) zones.push({name, rate});
    });

    const settings = {
      latitude, longitude, wateringFrequency, etReplacement, zones
    };
    localStorage.setItem("sprinklerSettings", JSON.stringify(settings));
  }

  function loadSettings() {
    const settingsStr = localStorage.getItem("sprinklerSettings");
    if(!settingsStr) return false;
    try {
      const settings = JSON.parse(settingsStr);
      if(settings.latitude) document.getElementById("latitude").value = settings.latitude;
      if(settings.longitude) document.getElementById("longitude").value = settings.longitude;
      if(settings.wateringFrequency) document.getElementById("wateringFrequency").value = settings.wateringFrequency;
      if(settings.etReplacement) document.getElementById("etReplacement").value = settings.etReplacement;
      if(settings.zones && Array.isArray(settings.zones)) {
        const container = document.getElementById("zones-container");
        container.innerHTML = "";
        settings.zones.forEach(z => {
          container.appendChild(createZoneRow(z.name, z.rate));
        });
      }
      return true;
    } catch(e) {
      console.error("Error loading settings:", e);
      return false;
    }
  }

  async function fetchWeatherData(lat, lon) {
    const today = new Date();
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&daily=precipitation_sum,et0_fao_evapotranspiration&forecast_days=7&timezone=auto&models=gfs_seamless`;

    const resp = await fetch(url);
    if(!resp.ok) throw new Error("Failed to fetch weather data");
    return resp.json();
  }

  function sumArray(arr) {
    return arr.reduce((a,b) => a + b, 0);
  }

  function calculateRuntime(ratePerInch, ET, R, wateringFrequencyDays, etReplacementPercent) {
    const W = wateringFrequencyDays ? wateringFrequencyDays / 7 : 2/7;
    const etReplace = etReplacementPercent ? etReplacementPercent / 100 : 0.75;
    const adjustedInches = W * (etReplace * ET - R);
    if(adjustedInches <= 0) return 0;
    return adjustedInches * ratePerInch;
  }

  function formatMinutes(mins) {
    if(mins <= 0) return "0 min";
    const hrs = Math.floor(mins / 60);
    const minutes = Math.round(mins % 60);
    return hrs > 0 ? `${hrs} hr ${minutes} min` : `${minutes} min`;
  }

  function clearResults() {
    const output = document.getElementById("results");
    output.textContent = "";
  }

  async function calculateSprinklerTimes() {
    const output = document.getElementById("results");
    output.textContent = "Fetching weather data...";

    const lat = parseFloat(document.getElementById("latitude").value);
    const lon = parseFloat(document.getElementById("longitude").value);
    if(isNaN(lat) || isNaN(lon)) {
      output.textContent = "Please enter valid latitude and longitude.";
      return;
    }

    const wateringFrequencyInput = document.getElementById("wateringFrequency").value;
    const wateringFrequency = wateringFrequencyInput ? parseFloat(wateringFrequencyInput) : 2;

    const etReplacementInput = document.getElementById("etReplacement").value;
    const etReplacement = etReplacementInput ? parseFloat(etReplacementInput) : 75;

    if(wateringFrequency <= 0 || etReplacement < 0 || etReplacement > 100) {
      output.textContent = "Please enter valid values for watering frequency and ET replacement %.";
      return;
    }

    const zones = [];
    document.querySelectorAll(".zone-row").forEach(row => {
      const name = row.querySelector(".zone-name").value.trim();
      const rate = parseFloat(row.querySelector(".zone-rate").value);
      if(name && !isNaN(rate) && rate > 0) {
        zones.push({name, ratePerInch: rate});
      }
    });

    if(zones.length === 0) {
      output.textContent = "Please add at least one sprinkler zone with valid name and rate.";
      return;
    }

    try {
      const data = await fetchWeatherData(lat, lon);

      if(!data.daily || !data.daily.precipitation_sum || !data.daily.et0_fao_evapotranspiration) {
        output.textContent = "Incomplete weather data received.";
        return;
      }

      const weeklyRainfall = sumArray(data.daily.precipitation_sum);
      const weeklyET = sumArray(data.daily.et0_fao_evapotranspiration);

      const resultLines = zones.map(({name, ratePerInch}) => {
        const runtime = calculateRuntime(ratePerInch, weeklyET, weeklyRainfall, wateringFrequency, etReplacement);
        return `${name}: ${formatMinutes(runtime)}`;
      });

      let resultText = 
        `Weekly ET: ${weeklyET.toFixed(3)} inches\n` +
        `Predicted 7-Day Rainfall: ${weeklyRainfall.toFixed(3)} inches\n\n` +
        `Sprinkler Timing (every ${wateringFrequency} day(s)):\n` +
        resultLines.join("\n");

      output.textContent = resultText;
      saveSettings();

    } catch(error) {
      output.textContent = `Error: ${error.message}`;
    }
  }

  document.getElementById("addZoneBtn").addEventListener("click", () => {
    const container = document.getElementById("zones-container");
    container.appendChild(createZoneRow());
    saveSettings();
  });

  document.getElementById("calculateBtn").addEventListener("click", calculateSprinklerTimes);

  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("Reset all inputs to default values? This will clear saved settings.")) {
      localStorage.removeItem("sprinklerSettings");
      document.getElementById("latitude").value = "";
      document.getElementById("longitude").value = "";
      document.getElementById("wateringFrequency").value = "";
      document.getElementById("etReplacement").value = "";
      document.getElementById("zones-container").innerHTML = "";
      clearResults();
    }
  });

  document.getElementById("latitude").addEventListener("input", saveSettings);
  document.getElementById("longitude").addEventListener("input", saveSettings);
  document.getElementById("wateringFrequency").addEventListener("input", saveSettings);
  document.getElementById("etReplacement").addEventListener("input", saveSettings);
  document.getElementById("zones-container").addEventListener("input", saveSettings);

  window.addEventListener("DOMContentLoaded", () => {
    const loaded = loadSettings();
    if (!loaded) {
      document.getElementById("zones-container").appendChild(createZoneRow());
    }
  });
</script>

</body>
</html>
