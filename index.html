<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sprinkler Runtime Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    max-width: 600px;
    background: #f0f4f8;
    color: #222;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.2rem;
  }
  p.description {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0;
    margin-bottom: 1.5rem;
    line-height: 1.4;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
  }
  input[type="number"], input[type="text"] {
    padding: 0.5rem;
    font-size: 1rem;
    width: 100%;
    margin-top: 0.3rem;
    border: 1px solid #bbb;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #sprinklerZones {
    margin-top: 1rem;
    border: 1px solid #ccc;
    background: #fff;
    padding: 1rem;
    border-radius: 6px;
  }
  .zone-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .zone-row input {
    flex: 1;
  }
  .zone-row input.zone-name {
    flex: 2;
  }
  button {
    margin-top: 1rem;
    padding: 0.7rem;
    font-size: 1.1rem;
    width: 100%;
    background-color: #007acc;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background-color: #005fa3;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  #results {
    margin-top: 2rem;
    background: white;
    padding: 1rem;
    border-radius: 6px;
    white-space: pre-line;
    box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
  }
  #addZoneBtn {
    background-color: #28a745;
    margin-top: 0.5rem;
  }
  #addZoneBtn:hover {
    background-color: #1e7e34;
  }
  #locationBtn {
    margin-top: 0.5rem;
    background-color: #6c757d;
  }
  #locationBtn:hover {
    background-color: #5a6268;
  }
  .labels-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-weight: bold;
  }
  .labels-row > div {
    flex: 1;
  }
  .labels-row > div.zone-name {
    flex: 2;
  }
  @media (max-width: 480px) {
    .zone-row {
      flex-direction: column;
    }
    .labels-row {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<h1>Sprinkler Runtime Calculator</h1>
<p class="description">
  Calculate the runtime for each sprinkler zone based on weather forecast data.<br/>
  <br/>
  Formula used (W = watering frequency in days, ET = weekly evapotranspiration, R = weekly rainfall, Rate = minutes per 1" water):<br/>
  <code>Runtime = (W / 7) × (ET × ET Replacement % - R) × Rate</code><br/>
  You can customize watering frequency and ET replacement below.<br/>
</p>

<label>
  Latitude:
  <input type="number" id="latitude" placeholder="Enter latitude (e.g., 47.94)" step="0.0001" />
</label>

<label>
  Longitude:
  <input type="number" id="longitude" placeholder="Enter longitude (e.g., -122.21)" step="0.0001" />
</label>

<button id="locationBtn" type="button">Use My Current Location</button>

<label>
  Watering Frequency (every X days):
  <input type="number" id="wateringFrequency" placeholder="e.g., 2 (water every 2 days)" min="1" />
</label>

<label>
  ET Replacement Percentage (%):
  <input type="number" id="etReplacement" placeholder="e.g., 75 for 75%" min="0" max="100" />
</label>

<div id="sprinklerZones">
  <div class="labels-row">
    <div class="zone-name">Sprinkler Zone Name</div>
    <div>Runtime per 1" (minutes)</div>
    <div style="width: 24px;"></div>
  </div>
  <!-- Zones will be appended here -->
</div>
<button id="addZoneBtn" type="button">+ Add Sprinkler Zone</button>

<button id="calculateBtn" type="button">Calculate Runtime</button>

<div id="results" style="display:none;"></div>

<script>
  const zonesContainer = document.getElementById("sprinklerZones");
  const resultsDiv = document.getElementById("results");

  // Add a sprinkler zone input row
  function addZone(name = "", rate = "") {
    const div = document.createElement("div");
    div.classList.add("zone-row");
    div.innerHTML = `
      <input type="text" class="zone-name" placeholder="Zone name" value="${name}" />
      <input type="number" min="0" placeholder="Minutes per 1 inch" value="${rate}" />
      <button type="button" title="Remove zone" aria-label="Remove zone">×</button>
    `;
    const btn = div.querySelector("button");
    btn.onclick = () => div.remove();
    zonesContainer.appendChild(div);
  }

  document.getElementById("addZoneBtn").addEventListener("click", () => addZone());

  // On page load, start with one empty zone
  addZone();

  // Get current location
  document.getElementById("locationBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("latitude").value = pos.coords.latitude.toFixed(4);
        document.getElementById("longitude").value = pos.coords.longitude.toFixed(4);
      },
      (err) => alert("Could not get location: " + err.message)
    );
  });

  function sumArray(arr) {
    return arr.reduce((a, b) => a + b, 0);
  }

  function formatMinutes(mins) {
    if (mins <= 0) return "0 min";
    let hrs = Math.floor(mins / 60);
    let minutes = Math.round(mins % 60);
    return hrs > 0 ? `${hrs} hr ${minutes} min` : `${minutes} min`;
  }

  async function fetchWeatherData(lat, lon) {
    const today = new Date();
    const startDate = today.toISOString().slice(0, 10);
    const endDateObj = new Date();
    endDateObj.setDate(today.getDate() + 6);
    const endDate = endDateObj.toISOString().slice(0, 10);

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&daily=precipitation_sum,et0_fao_evapotranspiration&forecast_days=7&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto&models=gfs_seamless`;

    const resp = await fetch(url);
    if (!resp.ok) throw new Error("Failed to fetch weather data");
    return resp.json();
  }

  document.getElementById("calculateBtn").addEventListener("click", async () => {
    resultsDiv.style.display = "block";
    resultsDiv.textContent = "Fetching weather data...";

    const lat = parseFloat(document.getElementById("latitude").value);
    const lon = parseFloat(document.getElementById("longitude").value);
    const wateringFreqInput = document.getElementById("wateringFrequency").value;
    const etReplacementInput = document.getElementById("etReplacement").value;

    // Validate inputs
    if (isNaN(lat) || isNaN(lon)) {
      resultsDiv.textContent = "Please enter valid latitude and longitude.";
      return;
    }
    if (!wateringFreqInput) {
      resultsDiv.textContent = "Please enter watering frequency (every X days).";
      return;
    }
    if (!etReplacementInput) {
      resultsDiv.textContent = "Please enter ET replacement percentage.";
      return;
    }

    const W = parseFloat(wateringFreqInput);
    const ETreplPercent = parseFloat(etReplacementInput) / 100;

    // Read sprinkler zones
    const zones = [];
    const rows = zonesContainer.querySelectorAll(".zone-row");
    for (const row of rows) {
      const name = row.querySelector(".zone-name").value.trim();
      const rateStr = row.querySelector("input[type='number']").value;
      const rate = parseFloat(rateStr);
      if (!name || isNaN(rate) || rate < 0) {
        resultsDiv.textContent = "Please enter valid zone names and runtimes.";
        return;
      }
      zones.push({ name, rate });
    }

    try {
      const data = await fetchWeatherData(lat, lon);

      if (!data.daily || !data.daily.precipitation_sum || !data.daily.et0_fao_evapotranspiration) {
        resultsDiv.textContent = "Incomplete weather data received.";
        return;
      }

      const weeklyRainfall = sumArray(data.daily.precipitation_sum);
      const weeklyET = sumArray(data.daily.et0_fao_evapotranspiration);

      // Calculate runtimes
      const resultLines = zones.map(({ name, rate }) => {
        // Apply formula: Runtime = (W/7) * (ET * ETrepl - R) * Rate
        let adjustedInches = (W / 7) * (weeklyET * ETreplPercent - weeklyRainfall);
        if (adjustedInches <= 0) adjustedInches = 0;
        const runtime = adjustedInches * rate;
        return `${name}: ${formatMinutes(runtime)}`;
      });

      resultsDiv.innerHTML =
        `<strong>Weekly ET (evapotranspiration):</strong> ${weeklyET.toFixed(3)} inches<br>` +
        `<strong>Predicted 7-Day Rainfall:</strong> ${weeklyRainfall.toFixed(3)} inches<br><br>` +
        `<strong>Sprinkler Runtime (every ${W} days, ${Math.round(ETreplPercent * 100)}% ET replacement):</strong><br>` +
        resultLines.join("<br>");
    } catch (error) {
      resultsDiv.textContent = `Error fetching weather data: ${error.message}`;
    }
  });
</script>

</body>
</html>
