<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sprinkler Runtime Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    color: #222;
    margin: 0;
    padding: 2rem;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  #container {
    max-width: 645px;
    width: 100%;
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    box-sizing: border-box;
  }
  h1 { text-align: center; margin-bottom: 0.2rem; }
  p.description {
    font-size: 0.9rem;
    color: #555;
    margin: 0;
    margin-bottom: 1.5rem;
    line-height: 1.4;
  }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  .or-divider {
    text-align: center;
    margin: 1rem 0;
    font-size: 1rem;
    color: #666;
  }
  input[type="number"], input[type="text"] {
    padding: 0.6rem;
    font-size: 1rem;
    width: 100%;
    margin-top: 0.3rem;
    border: 1px solid #bbb;
    border-radius: 6px;
    box-sizing: border-box;
  }
  #suggestions {
    border: 1px solid #ccc;
    border-top: none;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background: white;
    z-index: 10;
    width: calc(100% - 2px);
    display: none;
  }
  #suggestions div {
    padding: 0.5rem;
    cursor: pointer;
  }
  #suggestions div:hover {
    background: #f0f0f0;
  }
  #sprinklerZones {
    margin-top: 1rem;
    background: #f9fafb;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 8px;
  }
  .zone-row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
  .zone-row input {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .zone-row input.zone-name { flex: 2; }
  .zone-row input.zone-rate { flex: 1; }
  .zone-row button {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    width: 41px;
    font-size: 1.3rem;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
  }
  .zone-row button:hover { background: #b02a37; }
  button {
    margin-top: 1rem;
    padding: 0.75rem;
    font-size: 1.1rem;
    width: 100%;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.25s ease;
  }
  #addZoneBtn { background-color: #28a745; color: white; }
  #addZoneBtn:hover { background-color: #1e7e34; }
  #locationBtn { background-color: #007bff; color: white; }
  #locationBtn:hover { background-color: #0056b3; }
  #calculateBtn { background-color: #17a2b8; color: white; }
  #calculateBtn:hover { background-color: #117a8b; }
  #results {
    margin-top: 2rem;
    background: #e9f7fa;
    padding: 1rem;
    border-radius: 8px;
    white-space: pre-line;
    box-shadow: inset 0 0 10px rgb(0 123 255 / 0.2);
    font-size: 1rem;
    line-height: 1.4;
  }
  .labels-row { display: flex; gap: 0.75rem; margin: 0.25rem 0 0.75rem; font-weight: bold; font-size: 0.95rem; color: #555; }
  .labels-row > div.zone-name { flex: 2; }
  .labels-row > div.zone-rate { flex: 1; }
  @media (max-width: 480px) {
    .zone-row, .labels-row { flex-direction: column; }
    .zone-row input, .labels-row > div { width: 100%; flex: none; }
    .zone-row button { width: 100%; font-size: 1.5rem; margin-top: 0.25rem; }
  }
</style>
</head>
<body>
<div id="container">
  <h1>Sprinkler Runtime Calculator</h1>
  <p class="description">
    Calculate the runtime for your sprinkler zones based on NOAA GFS weather forecast data.<br><br>
    The runtime formula uses variables:<br><br>
    <code>W</code> = watering frequency in days<br>
    <code>ET</code> = weekly evapotranspiration in inches for your location<br>
    <code>R</code> = weekly total rainfall in inches for your location<br>
    <code>Rate</code> = minutes to irrigate 1" water for your sprinklers<br><br>
    Optional: Enter your own variable values and/or runtime formula using <code>W</code>, <code>ET</code>, <code>R</code>, and <code>Rate</code>.
  </p>

  <label>
    Location (City, ZIP, or Address):
    <input type="text" id="locationInput" placeholder="Enter city, ZIP code, or address" autocomplete="off" />
    <div id="suggestions"></div>
  </label>

  <div class="or-divider">â€” OR â€”</div>

  <label>
    Latitude:
    <input type="number" id="latitude" placeholder="Enter latitude" step="0.0001" />
  </label>

  <label>
    Longitude:
    <input type="number" id="longitude" placeholder="Enter longitude" step="0.0001" />
  </label>

  <button id="locationBtn" type="button">Use My Current Location</button>

  <label>
    (Optional) Watering Frequency (days):
    <input type="number" id="wateringFrequency" placeholder="Default: 2" min="1" />
  </label>

  <label>
    (Optional) ET Replacement (%):
    <input type="number" id="etReplacement" placeholder="Default: 75" min="0" max="100" />
  </label>

  <label>
    (Optional) Formula Override:
    <input type="text" id="formulaInput" placeholder="Default: (W / 7) * (ET * 0.75 - R) * Rate" />
  </label>

  <div id="sprinklerZones">
    <div class="labels-row">
      <div class="zone-name">Sprinkler Zone Name</div>
      <div class="zone-rate">Minutes per 1"</div>
      <div style="width: 32px;"></div>
    </div>
  </div>

  <button id="addZoneBtn" type="button">+ Add Sprinkler Zone</button>
  <button id="calculateBtn" type="button">Calculate Runtime</button>

  <div id="results" style="display:none;"></div>
</div>

<script>
const zonesContainer = document.getElementById("sprinklerZones");
const resultsDiv = document.getElementById("results");
const suggestionsDiv = document.getElementById("suggestions");
let selectedCoords = null;

function addZone(name = "", rate = "") {
  const div = document.createElement("div");
  div.classList.add("zone-row");
  div.innerHTML = `
    <input type="text" class="zone-name" placeholder="Zone name" value="${name}" />
    <input type="number" class="zone-rate" min="0" placeholder="Minutes per 1 inch" value="${rate}" />
    <button type="button">Ã—</button>
  `;
  div.querySelector("button").onclick = () => div.remove();
  zonesContainer.appendChild(div);
}

addZone();
document.getElementById("addZoneBtn").onclick = () => addZone();

function looksLikeAddress(q) {
  return /^\d/.test(q.trim()) || /\b(st|street|rd|road|ave|avenue|blvd|drive|dr|lane|ln)\b/i.test(q);
}

function formatSuggestion(item, isAddress) {
  const addr = item.address || {};
  if (isAddress) {
    const road = addr.road || addr.pedestrian || "";
    const house = addr.house_number || "";
    const city = addr.city || addr.town || addr.village || "";
    const state = addr.state || "";
    const postcode = addr.postcode || "";
    return `${house} ${road}, ${city}, ${state} ${postcode}, ${addr.country || ""}`.replace(/\s+/g, ' ').trim();
  } else {
    return item.display_name;
  }
}

async function fetchSuggestions(query) {
  if (!query) {
    suggestionsDiv.style.display = 'none';
    return;
  }
  const isAddress = looksLikeAddress(query);
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
  const res = await fetch(url);
  const data = await res.json();
  suggestionsDiv.innerHTML = '';
  data.forEach(item => {
    const div = document.createElement('div');
    div.textContent = formatSuggestion(item, isAddress);
    div.onclick = () => {
      document.getElementById('locationInput').value = div.textContent;
      document.getElementById('latitude').value = item.lat;
      document.getElementById('longitude').value = item.lon;
      selectedCoords = { lat: item.lat, lon: item.lon };
      suggestionsDiv.style.display = 'none';
    };
    suggestionsDiv.appendChild(div);
  });
  suggestionsDiv.style.display = 'block';
}

document.getElementById('locationInput').addEventListener('input', (e) => fetchSuggestions(e.target.value));

document.getElementById('locationBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(4);
    const lon = pos.coords.longitude.toFixed(4);
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;
    selectedCoords = { lat, lon };
  }, err => alert("Unable to get location."));
};

document.getElementById('calculateBtn').onclick = async () => {
  const lat = parseFloat(document.getElementById('latitude').value);
  const lon = parseFloat(document.getElementById('longitude').value);
  if (isNaN(lat) || isNaN(lon)) {
    alert("Please provide valid latitude and longitude.");
    return;
  }

  const zones = Array.from(document.querySelectorAll('.zone-row')).map(row => {
    return {
      name: row.querySelector('.zone-name').value,
      rate: parseFloat(row.querySelector('.zone-rate').value)
    };
  }).filter(z => z.name && !isNaN(z.rate));

  if (!zones.length) {
    alert("Please add at least one sprinkler zone with valid rate.");
    return;
  }

  const W = parseFloat(document.getElementById('wateringFrequency').value) || 2;
  const ETreplace = parseFloat(document.getElementById('etReplacement').value) || 75;
  const formulaOverride = document.getElementById('formulaInput').value;

  // Placeholder for weather fetching; replace with NOAA GFS or other API
  const ET = 1.0; // example weekly evapotranspiration in inches
  const R = 0.2; // example weekly rainfall in inches

  let outputText = `ðŸžï¸ Sprinkler Runtime Results\n\n`;
  outputText += `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n`;
  outputText += `Watering Frequency (W): ${W} days\n`;
  outputText += `Weekly Evapotranspiration (ET): ${ET.toFixed(2)} inches\n`;
  outputText += `Weekly Rainfall Total (R): ${R.toFixed(2)} inches\n`;
  outputText += `ET Replacement: ${ETreplace}%\n\n`;
  outputText += `ðŸ’§ Sprinkler Zone Runtimes:\n`;

  zones.forEach(zone => {
    const rate = zone.rate;
    let runtime;
    if (formulaOverride) {
      try {
        runtime = eval(formulaOverride.replace(/W/g, W).replace(/ET/g, ET).replace(/R/g, R).replace(/Rate/g, rate));
      } catch (e) {
        runtime = 0;
      }
    } else {
      runtime = (W/7) * (ET*(ETreplace/100) - R) * rate;
    }
    runtime = Math.max(0, runtime).toFixed(1);
    outputText += `â€¢ ${zone.name}: ${runtime} minutes\n`;
  });

  outputText += `\nExplanation:\n`;
  outputText += `The runtime for each zone is calculated based on the weekly ET, rainfall, watering frequency, and your sprinkler rate.\n`;
  outputText += `If ET*ET Replacement is greater than rainfall, the difference is applied to determine irrigation needed.\n`;
  outputText += `Minutes per zone are adjusted according to each zone's Rate.\n`;

  resultsDiv.textContent = outputText;
  resultsDiv.style.display = 'block';
};
</script>
</body>
</html>