<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sprinkler Runtime Calculator</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2rem; max-width: 600px; }
  label { display: block; margin-top: 1rem; }
  input, button { padding: 0.5rem; font-size: 1rem; margin-top: 0.3rem; width: 100%; }
  #results { margin-top: 2rem; white-space: pre-line; background: #f9f9f9; padding: 1rem; border-radius: 5px; }
</style>
</head>
<body>

<h1>Sprinkler Runtime Calculator</h1>

<label>
  Latitude:
  <input type="number" id="latitude" value="47.94" step="0.0001" />
</label>

<label>
  Longitude:
  <input type="number" id="longitude" value="-122.21" step="0.0001" />
</label>

<label>
  Enter sprinklers and runtimes (minutes per 1" water), comma-separated:<br/>
  Example: Front Yard:240,Upper Backyard:320,Bottom Backyard:120
  <input type="text" id="sprinklers" value="Front Yard:240,Upper Backyard:320,Bottom Backyard:120" />
</label>

<button id="calculateBtn">Calculate Runtime</button>

<div id="results"></div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const wateringFrequency = 2 / 7;  // watering every 2 days
  const etReplacement = 0.75;       // 75% ET replacement

  function sumArray(arr) {
    return arr.reduce((a, b) => a + b, 0);
  }

  function calculateRuntime(ratePerInch, ET, R) {
    let adjustedInches = wateringFrequency * (etReplacement * ET - R);
    if (adjustedInches <= 0) return 0;
    return adjustedInches * ratePerInch;
  }

  function formatMinutes(mins) {
    if (mins <= 0) return "0 min";
    let hrs = Math.floor(mins / 60);
    let minutes = Math.round(mins % 60);
    return hrs > 0 ? `${hrs} hr ${minutes} min` : `${minutes} min`;
  }

  async function fetchWeatherData(lat, lon) {
    const today = new Date();
    const startDate = today.toISOString().slice(0, 10);
    const endDateObj = new Date();
    endDateObj.setDate(today.getDate() + 6);
    const endDate = endDateObj.toISOString().slice(0, 10);

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&daily=precipitation_sum,et0_fao_evapotranspiration&forecast_days=7&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto&models=gfs_seamless`;

    const resp = await fetch(url);
    if (!resp.ok) throw new Error("Failed to fetch weather data");
    return resp.json();
  }

  async function calculateSprinklerTimes() {
    const output = document.getElementById("results");
    output.textContent = "Fetching weather data...";

    const lat = parseFloat(document.getElementById("latitude").value);
    const lon = parseFloat(document.getElementById("longitude").value);

    const sprinklerInput = document.getElementById("sprinklers").value;
    const sprinklers = sprinklerInput.split(",").map(item => {
      const [name, rate] = item.split(":");
      return { name: name.trim(), ratePerInch: parseFloat(rate.trim()) };
    });

    try {
      const data = await fetchWeatherData(lat, lon);

      if (!data.daily || !data.daily.precipitation_sum || !data.daily.et0_fao_evapotranspiration) {
        output.textContent = "Incomplete weather data received.";
        return;
      }

      const weeklyRainfall = sumArray(data.daily.precipitation_sum);
      const weeklyET = sumArray(data.daily.et0_fao_evapotranspiration);

      const resultLines = sprinklers.map(({ name, ratePerInch }) => {
        const runtime = calculateRuntime(ratePerInch, weeklyET, weeklyRainfall);
        return `${name}: ${formatMinutes(runtime)}`;
      });

      output.textContent =
        `Weekly ET: ${weeklyET.toFixed(2)} inches\n` +
        `Predicted 7-Day Rainfall: ${weeklyRainfall.toFixed(2)} inches\n\n` +
        `Sprinkler Timing (every 2 days):\n` +
        resultLines.join("\n");

    } catch (error) {
      output.textContent = `Error: ${error.message}`;
    }
  }

  document.getElementById("calculateBtn").addEventListener("click", calculateSprinklerTimes);
});
</script>

</body>
</html>

